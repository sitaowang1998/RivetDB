syntax = "proto3";

package rivetdb;

message BeginTransactionRequest {
    string client_id = 1;
}

message BeginTransactionResponse {
    string txn_id = 1;
    uint64 snapshot_ts = 2;
}

message GetRequest {
    string txn_id = 1;
    string key = 2;
}

message GetResponse {
    oneof outcome {
        GetSuccess success = 1;
        string error_message = 2;
    }
}

message GetSuccess {
    bool found = 1;
    bytes value = 2;
    uint64 commit_ts = 3;
}

message PutRequest {
    string txn_id = 1;
    string key = 2;
    bytes value = 3;
}

message PutResponse {
    oneof outcome {
        PutSuccess success = 1;
        string error_message = 2;
    }
}

message PutSuccess {}

message CommitRequest {
    string txn_id = 1;
}

message CommitResponse {
    oneof outcome {
        CommitSuccess success = 1;
        string error_message = 2;
    }
}

message CommitSuccess {
    uint64 commit_ts = 1;
}

message WriteMutation {
    string key = 1;
    bytes value = 2;
}

message ShipTransactionRequest {
    string txn_id = 1;
    uint64 snapshot_ts = 2;
    repeated string read_keys = 3;
    repeated WriteMutation writes = 4;
}

message AbortRequest {
    string txn_id = 1;
}

message AbortResponse {
    oneof outcome {
        AbortSuccess success = 1;
        string error_message = 2;
    }
}

message AbortSuccess {}

service RivetKv {
    rpc BeginTransaction(BeginTransactionRequest) returns (BeginTransactionResponse);
    rpc Get(GetRequest) returns (GetResponse);
    rpc Put(PutRequest) returns (PutResponse);
    rpc Commit(CommitRequest) returns (CommitResponse);
    rpc Abort(AbortRequest) returns (AbortResponse);
    rpc ShipTransaction(ShipTransactionRequest) returns (CommitResponse);
}

// Generic Raft RPC surface: payloads are serialized with Serde on the Rust side.
message RaftRequest {
    bytes data = 1;
}

message RaftResponse {
    bytes data = 1;
}

service RivetRaft {
    rpc AppendEntries(RaftRequest) returns (RaftResponse);
    rpc InstallSnapshot(RaftRequest) returns (RaftResponse);
    rpc Vote(RaftRequest) returns (RaftResponse);
}
